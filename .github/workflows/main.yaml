name: Main workflow
permissions:
  contents: read
  packages: write

on:
  push:
    branches: [main]

jobs:
  format:
    name: Format
    uses: "./.github/workflows/format.yaml"

  check:
    name: Check
    uses: "./.github/workflows/check.yaml"

  prepare:
    name: Prepare
    uses: "./.github/workflows/prepare.yaml"
    needs: [format, check]

  pipeline:
    name: Package Pipeline
    uses: "./.github/workflows/pipeline.yaml"
    needs: [prepare]
    if: ${{ success() && needs.prepare.outputs.services != '[]' }}
    strategy:
      matrix:
        service: ${{ fromJson(needs.prepare.outputs.docker-services) }}
      fail-fast: false
    with:
      service: "${{ toJson(matrix.service) }}"

  report:
    name: Report
    uses: "./.github/workflows/report.yaml"
    needs: pipeline
    if: ${{ !cancelled() }}
    secrets:
      chat: "${{ secrets.TELEGRAM_REPORT_CHAT }}"
      token: "${{ secrets.TELEGRAM_REPORT_TOKEN }}"
